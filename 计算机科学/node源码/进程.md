# 进程

## child_process 

是Node的一个十分重要的模块，通过它可以实现创建多进程，以利用单机的多核计算资源。

Nodejs天生是单线程单进程的，但是有了child_process模块，可以在程序中直接创建子进程，并使用主进程和子进程之间实现通信。

### 进程通信原理IPC

IPC这个词我想大家并不陌生，不管那一张开发语言只要提到进程通信，都会提到它。IPC的全称是Inter-Process Communication,即进程间通信

每个进程各自有不同的用户地址空间，进程内的全局变量在另一个进程中都看不到；

通信方法：在内核中开辟一块缓冲区，进程1把数据从用户空间拷到内核缓冲区，进程2再从内核缓冲区把数据读走；

### 创建子进程child_process

- spawn()启动一个子进程来执行命令
- exec()启动一个子进程来执行命令, 带回调参数获知子进程的情况, 可指定进程运行的超时时间【有恶意参数风险，建议用execFile】
- execFile()启动一个子进程来执行一个可执行文件, 可指定进程运行的超时时间
- fork() 与spawn()类似, 不同在于它创建的node子进程只需指定要执行的js文件模块即可

## cluster：封装了创建子进程、进程间通信、服务负载均衡

 cluster模块封装了创建子进程、进程间通信、服务负载均衡。有两类进程，master进程和worker进程，master进程是主控进程，它负责启动worker进程，worker是子进程、干活的进程。

## worker竞争关系：round-robin (轮询)

- 所有请求先统一经过内部TCP服务器。
- 在内部TCP服务器的请求处理逻辑中，有负载均衡地挑选出一个worker进程，向其发送一个newconn内部消息，随消息发送客户端句柄。
- Worker进程接收到此内部消息，根据客户端句柄创建net.Socket实例，执行具体业务逻辑，返回。

## listen端口复用

- 端口仅由master进程中的内部TCP服务器监听了一次。
- 不会出现端口被重复监听报错，是由于，worker进程中，最后执行监听端口操作的方法，已被cluster模块主动覆盖。

## ps：惊群效应：

惊群效应（thundering herd）是指多进程（多线程）在同时阻塞等待同一个事件的时候（休眠状态），如果等待的这个事件发生，那么他就会唤醒等待的所有进程（或者线程），但是最终却只能有一个进程（线程）获得这个时间的“控制权”，对该事件进行处理，而其他进程（线程）获取“控制权”失败，只能重新进入休眠状态，这种现象和性能浪费就叫做惊群效应。



